<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Puff Run - Dream Edition Super Advanced</title>
<style>
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  font-family: 'Rubik', sans-serif;
  overflow: hidden;
  color: white;
}

#game-canvas {
  display: block;
  margin: 0 auto;
  background: rgba(255, 255, 255, 0.05);
  border: 2px solid rgba(255, 255, 255, 0.2);
  border-radius: 15px;
  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
}

#score-display, #high-score-display {
  position: absolute;
  font-size: 1.5rem;
  font-weight: 700;
  color: white;
  text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
  z-index: 10;
}

#score-display {
  top: 20px;
  left: 20px;
}

#high-score-display {
  top: 20px;
  right: 20px;
}

#level-message {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  font-size: 3rem;
  font-weight: 700;
  color: #ff6b6b;
  text-shadow: 3px 3px 6px rgba(0, 0, 0, 0.7);
  z-index: 100;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.3s ease;
}

#message-box {
  position: absolute;
  bottom: 20px;
  left: 50%;
  transform: translateX(-50%);
  font-size: 1.2rem;
  font-weight: 700;
  color: #4ecdc4;
  text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
  z-index: 10;
  opacity: 0;
  transition: opacity 0.3s ease;
}

#toggle-sound, #toggle-pause {
  position: absolute;
  top: 70px;
  right: 20px;
  width: 40px;
  height: 40px;
  border: none;
  background: transparent;
  color: white;
  font-size: 1.2rem;
  cursor: pointer;
  z-index: 10;
}

#toggle-pause {
  right: 70px;
}

#start-screen, #game-over-screen, #continue-screen, #skin-store {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  background: rgba(0, 0, 0, 0.8);
  z-index: 1000;
  backdrop-filter: blur(20px);
}

#start-screen div:first-child {
  font-size: 3rem;
  font-weight: 700;
  margin-bottom: 30px;
  text-align: center;
  background: linear-gradient(45deg, #ff6b6b, #4ecdc4, #45b7d1);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  animation: pulse 2s infinite;
}

@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.7; }
}

button {
  padding: 15px 30px;
  margin: 10px;
  font-size: 1.2rem;
  font-weight: 700;
  font-family: 'Rubik', sans-serif;
  border: none;
  border-radius: 25px;
  background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
  color: white;
  cursor: pointer;
  transition: all 0.3s ease;
  box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
}

button:hover {
  transform: translateY(-3px);
  box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
}

button:active {
  transform: translateY(-1px);
}

button:disabled {
  opacity: 0.6;
  cursor: not-allowed;
  transform: none;
}

#skin-store {
  padding: 10px;
  overflow-y: auto;
}

#skin-store h2 {
  font-size: 1.8rem;
  margin-bottom: 15px;
  background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

#skin-list {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 10px;
  max-width: 320px;
  margin: 0 auto 15px auto;
}

#skin-list button {
  width: 90px;
  height: 70px;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  text-align: center;
  border: 2px solid rgba(255, 255, 255, 0.3);
  font-size: 0.8rem;
  padding: 5px;
}

.price-tag {
  font-size: 0.7rem;
  opacity: 0.8;
  margin-top: 2px;
}

#close-skin-store-btn {
  padding: 8px 16px;
  font-size: 1rem;
}

@media (max-width: 768px) {
  #start-screen div:first-child {
    font-size: 1.8rem;
  }
  
  #score-display, #high-score-display {
    font-size: 1rem;
    top: 10px;
  }
  
  #score-display {
    left: 10px;
  }
  
  #high-score-display {
    right: 10px;
  }
  
  #level-message {
    font-size: 1.5rem;
  }
  
  button {
    padding: 10px 20px;
    font-size: 0.9rem;
  }
  
  #toggle-sound, #toggle-pause {
    top: 50px;
    right: 10px;
    font-size: 1rem;
  }
  
  #toggle-pause {
    right: 50px;
  }
  
  #game-canvas {
    border-radius: 10px;
  }
}
</style>
<link href="https://fonts.googleapis.com/css2?family=Rubik:wght@700&display=swap" rel="stylesheet" />
</head>
<body>

<canvas id="game-canvas"></canvas>
<div id="score-display">Score: 0</div>
<div id="high-score-display"></div>
<div id="level-message"></div>
<div id="message-box"></div>
<button id="toggle-sound" title="Toggle Sound">üîä</button>
<button id="toggle-pause" title="Pause/Resume">‚è∏Ô∏è</button>

<div id="start-screen">
  <div>Welcome to Puff Run - Dream Edition</div>
  <button id="play-btn">Start Game</button>
  <button id="store-btn">üé® Skins</button>
  <div style="font-size: 0.9rem; margin-top: 20px; opacity: 0.7;">Use Arrow keys, A/D, or touch screen to move</div>
</div>

<div id="game-over-screen" style="display:none;">
  <div id="score-display-final"></div>
  <button id="retry-btn">Play Again</button>
</div>

<div id="continue-screen" style="display:none;">
  <div>You hit an obstacle! Watch an ad to continue?</div>
  <button id="watch-ad-btn">Watch Ad</button>
  <button id="no-thanks-btn">No Thanks</button>
</div>

<div id="skin-store" style="display:none;">
  <h2>Select Your Dreamy Skin</h2>
  <div id="skin-list"></div>
  <button id="close-skin-store-btn">Close</button>
</div>

<script>
(() => {
  const canvas = document.getElementById('game-canvas');
  const ctx = canvas.getContext('2d');
  const scoreDisplay = document.getElementById('score-display');
  const highScoreDisplay = document.getElementById('high-score-display');
  const levelMessage = document.getElementById('level-message');
  const messageBox = document.getElementById('message-box');
  const toggleSoundBtn = document.getElementById('toggle-sound');
  const togglePauseBtn = document.getElementById('toggle-pause');
  const bgMusic = new Audio();
  const hitSound = new Audio();
  const powerupSound = new Audio();
  const skinList = document.getElementById('skin-list');
  const body = document.body;

  let width, height;
  let gameActive = false;
  let paused = false;
  let adPlaying = false;
  let score = 0;
  let highScore = 0;
  let currentLevel = 1;
  let obstacles = [];
  let powerups = [];
  let particles = [];
  let player = null;
  let soundOn = true;
  let continueAvailable = false;
  let powerupActive = null;
  let powerupTimer = 0;

  const skins = [
    { 
        name: 'Classic', 
        unlocked: true, 
        price: 0,
        theme: {
            playerColors: ['#ff6b6b', '#4ecdc4'],
            obstacleColors: ['#ff6b6b', '#e17055', '#d63031'],
            backgroundGradient: ['#667eea', '#764ba2']
        }
    },
    { 
        name: 'Ocean', 
        unlocked: false, 
        price: 0.99,
        theme: {
            playerColors: ['#74b9ff', '#0984e3'],
            obstacleColors: ['#00cec9', '#00b894', '#55efc4'],
            backgroundGradient: ['#00c6ff', '#0072ff']
        }
    },
    { 
        name: 'Sunset', 
        unlocked: false, 
        price: 2.99,
        theme: {
            playerColors: ['#fd79a8', '#fdcb6e'],
            obstacleColors: ['#ff7675', '#d63031', '#e17055'],
            backgroundGradient: ['#ff9a9e', '#fad0c4']
        }
    },
    { 
        name: 'Cyber', 
        unlocked: false, 
        price: 7.99,
        theme: {
            playerColors: ['#f8f8f8', '#e0e0e0'],
            obstacleColors: ['#f9ca24', '#f0932b', '#ffbe76'],
            backgroundGradient: ['#141E30', '#243B55']
        }
    },
    { 
        name: 'Galaxy', 
        unlocked: false, 
        price: 15.00,
        theme: {
            playerColors: ['#a29bfe', '#6c5ce7', '#fd79a8'],
            obstacleColors: ['#a29bfe', '#6c5ce7', '#81ecec'],
            backgroundGradient: ['#232526', '#414345']
        }
    }
  ];

  let selectedSkin = skins[0];

  function saveGameData() {
    const data = {
      highScore: highScore,
      unlockedSkins: skins.filter(s => s.unlocked).map(s => s.name),
      selectedSkinName: selectedSkin.name
    };
    try {
      localStorage.setItem('puffRunSaveData', JSON.stringify(data));
    } catch (e) {
      console.error('Could not save game data to localStorage.', e);
    }
  }

  function loadGameData() {
    try {
      const savedDataJSON = localStorage.getItem('puffRunSaveData');
      if (savedDataJSON) {
        const data = JSON.parse(savedDataJSON);
        highScore = data.highScore || 0;
        
        if (data.unlockedSkins) {
          skins.forEach(skin => {
            if (data.unlockedSkins.includes(skin.name)) {
              skin.unlocked = true;
            }
          });
        }
        
        if (data.selectedSkinName) {
          const found = skins.find(s => s.name === data.selectedSkinName);
          if (found && found.unlocked) {
            selectedSkin = found;
          }
        }
      }
    } catch (e) {
      console.error('Could not load game data from localStorage.', e);
    }
    // Apply the loaded theme
    applyTheme();
  }

  function applyTheme() {
    body.style.background = `linear-gradient(135deg, ${selectedSkin.theme.backgroundGradient[0]} 0%, ${selectedSkin.theme.backgroundGradient[1]} 100%)`;
    if(player) {
      player.colors = selectedSkin.theme.playerColors;
    }
  }
  
  function createPlayer() {
    player = {
      x: width/2,
      y: height - 75,
      radius: 26,
      velocityX: 0,
      acceleration: 1.1,
      maxSpeed: 10 + currentLevel * 0.3,
      friction: 0.85,
      colors: selectedSkin.theme.playerColors,
      shield: false,
      shieldAlpha: 0,
      movingLeft: false,
      movingRight: false
    };
  }
  
  function drawBackground() {
      // Background is now handled by the body's CSS gradient set in applyTheme()
      // This function can be used for drawing dynamic canvas elements if needed in the future
  }

  function drawPlayer() {
    if (!player) return;

    ctx.save();
    ctx.translate(player.x, player.y);

    if (player.shield) {
      ctx.globalAlpha = player.shieldAlpha;
      ctx.strokeStyle = '#4ecdc4';
      ctx.lineWidth = 4;
      ctx.beginPath();
      ctx.arc(0, 0, player.radius + 10, 0, Math.PI * 2);
      ctx.stroke();
    }

    ctx.globalAlpha = 1;
    
    const gradient = ctx.createRadialGradient(0, 0, 0, 0, 0, player.radius);
    if (player.colors.length === 3) {
      gradient.addColorStop(0, player.colors[0]);
      gradient.addColorStop(0.5, player.colors[1]);
      gradient.addColorStop(1, player.colors[2]);
    } else {
      gradient.addColorStop(0, player.colors[0]);
      gradient.addColorStop(1, player.colors[1]);
    }
    
    ctx.fillStyle = gradient;
    ctx.beginPath();
    ctx.arc(0, 0, player.radius, 0, Math.PI * 2);
    ctx.fill();

    ctx.fillStyle = 'rgba(255, 255, 255, 0.3)';
    ctx.beginPath();
    ctx.arc(-8, -8, player.radius * 0.3, 0, Math.PI * 2);
    ctx.fill();

    ctx.restore();
  }

  function drawObstacles() {
    obstacles.forEach(obstacle => {
      ctx.save();
      ctx.translate(obstacle.x + obstacle.width/2, obstacle.y + obstacle.height/2);
      ctx.rotate(obstacle.rotation);
      
      const gradient = ctx.createRadialGradient(0, 0, 0, 0, 0, obstacle.width/2);
      gradient.addColorStop(0, obstacle.color);
      gradient.addColorStop(1, '#2d3436');
      ctx.fillStyle = gradient;
      
      if (obstacle.type === 'circle') {
        ctx.beginPath();
        ctx.arc(0, 0, obstacle.width/2, 0, Math.PI * 2);
        ctx.fill();
      } else if (obstacle.type === 'triangle') {
        ctx.beginPath();
        ctx.moveTo(0, -obstacle.height/2);
        ctx.lineTo(-obstacle.width/2, obstacle.height/2);
        ctx.lineTo(obstacle.width/2, obstacle.height/2);
        ctx.closePath();
        ctx.fill();
      } else {
        ctx.beginPath();
        ctx.roundRect(-obstacle.width/2, -obstacle.height/2, obstacle.width, obstacle.height, 8);
        ctx.fill();
      }
      
      ctx.strokeStyle = 'rgba(255, 255, 255, 0.3)';
      ctx.lineWidth = 2;
      ctx.stroke();
      
      ctx.restore();
      obstacle.rotation += 0.05;
    });
  }

  function drawPowerups() {
    powerups.forEach(powerup => {
      ctx.save();
      ctx.translate(powerup.x + powerup.size/2, powerup.y + powerup.size/2);
      ctx.rotate(powerup.rotation);
      
      ctx.fillStyle = powerup.color;
      ctx.fillRect(-powerup.size/2, -powerup.size/2, powerup.size, powerup.size);
      
      ctx.restore();
      powerup.rotation += 0.1;
    });
  }

  function drawParticles() {
    particles.forEach((particle, index) => {
      ctx.save();
      ctx.globalAlpha = particle.alpha;
      ctx.fillStyle = particle.color;
      ctx.beginPath();
      ctx.arc(particle.x, particle.y, particle.size, 0, Math.PI * 2);
      ctx.fill();
      ctx.restore();

      particle.x += particle.velocityX;
      particle.y += particle.velocityY;
      particle.alpha -= 0.02;
      particle.size *= 0.98;

      if (particle.alpha <= 0) {
        particles.splice(index, 1);
      }
    });
  }

  function createParticles(x, y, color, count = 10) {
    for (let i = 0; i < count; i++) {
      particles.push({
        x: x,
        y: y,
        velocityX: (Math.random() - 0.5) * 10,
        velocityY: (Math.random() - 0.5) * 10,
        alpha: 1,
        size: Math.random() * 8 + 2,
        color: color
      });
    }
  }

  function spawnObstacle() {
    const types = ['circle', 'triangle', 'rect'];
    const type = types[Math.floor(Math.random() * types.length)];
    const colors = selectedSkin.theme.obstacleColors;
    
    obstacles.push({
      x: Math.random() * (width - 50),
      y: -40,
      width: 30 + Math.random() * 20,
      height: 30 + Math.random() * 20,
      speed: 3 + currentLevel * 0.5,
      type: type,
      color: colors[Math.floor(Math.random() * colors.length)],
      rotation: 0
    });
  }

  function spawnPowerup() {
    const types = ['shield', 'slow', 'points'];
    const type = types[Math.floor(Math.random() * types.length)];
    const colors = { shield: '#4ecdc4', slow: '#45b7d1', points: '#f39c12' };
    
    powerups.push({
      x: Math.random() * (width - 40),
      y: -30,
      size: 25,
      speed: 2 + currentLevel * 0.3,
      type: type,
      color: colors[type],
      rotation: 0
    });
  }

  function checkCollisions() {
    if (!player) return;

    if (!player.shield) {
        obstacles.forEach((obstacle) => {
          const dx = player.x - (obstacle.x + obstacle.width/2);
          const dy = player.y - (obstacle.y + obstacle.height/2);
          const distance = Math.sqrt(dx*dx + dy*dy);
          
          if (distance < player.radius + obstacle.width/2) {
            createParticles(player.x, player.y, '#ff6b6b', 15);
            if (soundOn) hitSound.play().catch(() => {});
            
            if (!continueAvailable) {
              continueAvailable = true;
              gameActive = false;
              paused = true;
              document.getElementById('continue-screen').style.display = 'flex';
            } else {
              endGame();
            }
          }
        });
    }

    powerups.forEach((powerup, index) => {
      const dx = player.x - (powerup.x + powerup.size/2);
      const dy = player.y - (powerup.y + powerup.size/2);
      const distance = Math.sqrt(dx*dx + dy*dy);
      
      if (distance < player.radius + powerup.size/2) {
        createParticles(powerup.x, powerup.y, powerup.color, 8);
        if (soundOn) powerupSound.play().catch(() => {});
        
        activatePowerup(powerup.type);
        powerups.splice(index, 1);
      }
    });
  }

  function activatePowerup(type) {
    powerupActive = type;
    powerupTimer = 300;
    
    switch (type) {
      case 'shield':
        player.shield = true;
        player.shieldAlpha = 0.8;
        showMessage('Shield Active!');
        break;
      case 'slow':
        obstacles.forEach(obs => obs.speed *= 0.5);
        showMessage('Time Slowed!');
        break;
      case 'points':
        score += 50;
        updateDisplays();
        showMessage('+50 Points!');
        break;
    }
  }

  function updatePowerups() {
    if (powerupActive && powerupTimer > 0) {
      powerupTimer--;
      
      if (powerupActive === 'shield' && player.shield) {
        player.shieldAlpha = Math.sin(powerupTimer * 0.2) * 0.3 + 0.5;
      }
      
      if (powerupTimer === 0) {
        if (powerupActive === 'shield') {
          player.shield = false;
          player.shieldAlpha = 0;
        } else if (powerupActive === 'slow') {
          obstacles.forEach(obs => obs.speed *= 2);
        }
        powerupActive = null;
      }
    }
  }

  function showMessage(text) {
    messageBox.textContent = text;
    messageBox.style.opacity = '1';
    setTimeout(() => {
      messageBox.style.opacity = '0';
    }, 2000);
  }

  function showLevelMessage(level) {
    levelMessage.textContent = `Level ${level}`;
    levelMessage.style.opacity = '1';
    setTimeout(() => {
      levelMessage.style.opacity = '0';
    }, 2000);
  }

  function updateGame() {
    if (!player) return;

    if (player.movingLeft) {
      player.velocityX -= player.acceleration;
    }
    if (player.movingRight) {
      player.velocityX += player.acceleration;
    }

    player.velocityX *= player.friction;
    player.velocityX = Math.max(-player.maxSpeed, Math.min(player.maxSpeed, player.velocityX));
    
    player.x += player.velocityX;
    player.x = Math.max(player.radius, Math.min(width - player.radius, player.x));

    obstacles.forEach((obstacle, index) => {
      obstacle.y += obstacle.speed;
      if (obstacle.y > height) {
        obstacles.splice(index, 1);
        score += 10;
      }
    });

    powerups.forEach((powerup, index) => {
      powerup.y += powerup.speed;
      if (powerup.y > height) {
        powerups.splice(index, 1);
      }
    });

    if (Math.random() < 0.015 + currentLevel * 0.002) {
      spawnObstacle();
    }

    if (Math.random() < 0.005) {
      spawnPowerup();
    }

    const newLevel = Math.floor(score / 200) + 1;
    if (newLevel > currentLevel) {
      currentLevel = newLevel;
      showLevelMessage(currentLevel);
      player.maxSpeed = 10 + currentLevel * 0.3;
    }

    updatePowerups();
    checkCollisions();
    
    updateDisplays();
  }
  
  function updateDisplays() {
      scoreDisplay.textContent = `Score: ${score}`;
      highScoreDisplay.textContent = `High Score: ${highScore}`;
  }

  function gameLoop() {
    if (!gameActive || adPlaying) {
        requestAnimationFrame(gameLoop);
        return;
    }
    
    if(!paused) {
        ctx.clearRect(0, 0, width, height);
        drawBackground();
        drawPlayer();
        drawObstacles();
        drawPowerups();
        drawParticles();
        
        updateGame();
    }
    
    requestAnimationFrame(gameLoop);
  }

  function startGame() {
    score = 0;
    currentLevel = 1;
    obstacles = [];
    powerups = [];
    particles = [];
    createPlayer();
    gameActive = true;
    paused = false;
    continueAvailable = false;
    adPlaying = false;
    powerupActive = null;
    powerupTimer = 0;

    document.getElementById('start-screen').style.display = 'none';
    document.getElementById('game-over-screen').style.display = 'none';
    document.getElementById('continue-screen').style.display = 'none';
    
    if (soundOn) {
      bgMusic.loop = true;
      bgMusic.volume = 0.4;
      bgMusic.play().catch(() => {});
    }
    
    updateDisplays();
  }

  function endGame() {
    gameActive = false;
    paused = true;
    if (score > highScore) {
      highScore = score;
    }
    document.getElementById('score-display-final').textContent = `Final Score: ${score}`;
    document.getElementById('game-over-screen').style.display = 'flex';
    bgMusic.pause();
    saveGameData();
    updateDisplays();
  }

  function renderSkinStore() {
    skinList.innerHTML = '';
    skins.forEach(skin => {
      const btn = document.createElement('button');
      
      const btnGradient = `linear-gradient(135deg, ${skin.theme.playerColors[0]}, ${skin.theme.playerColors[1]})`;
      btn.style.background = btnGradient;
      
      const priceText = skin.price === 0 ? 'Free' : `$${skin.price.toFixed(2)}`;
      const statusText = skin.unlocked ? '‚úîÔ∏è Equipped' : priceText;
      btn.innerHTML = `${skin.name}<br><span class="price-tag">${statusText}</span>`;
      
      btn.onclick = () => {
        if(skin.unlocked) {
            selectedSkin = skin;
            saveGameData();
            applyTheme();
            showMessage(`Equipped ${skin.name}`);
            renderSkinStore(); // Re-render to show "Equipped" status
        } else {
            // SIMULATE a real money purchase
            if (confirm(`Do you want to buy the "${skin.name}" theme for $${skin.price.toFixed(2)}?`)) {
                skin.unlocked = true;
                selectedSkin = skin;
                saveGameData();
                applyTheme();
                renderSkinStore();
                showMessage(`Purchased ${skin.name}`);
            }
        }
      };

      if(skin.unlocked && skin.name === selectedSkin.name){
        btn.style.borderColor = '#4CAF50';
        btn.innerHTML = `${skin.name}<br><span class="price-tag">‚úîÔ∏è Equipped</span>`;
      } else {
        btn.style.borderColor = 'rgba(255, 255, 255, 0.3)';
      }

      skinList.appendChild(btn);
    });
  }

  function resize() {
    width = window.innerWidth;
    height = window.innerHeight;
    canvas.width = width;
    canvas.height = height;
    if (player) {
      player.y = height - 75;
      player.x = Math.max(player.radius, Math.min(player.x, width - player.radius));
    }
  }

  window.addEventListener('resize', resize);

  window.addEventListener('keydown', e => {
    if (!player || !gameActive || paused || adPlaying) return;
    if (e.key === 'ArrowLeft' || e.key === 'a' || e.key === 'A') player.movingLeft = true;
    if (e.key === 'ArrowRight' || e.key === 'd' || e.key === 'D') player.movingRight = true;
  });

  window.addEventListener('keyup', e => {
    if (!player) return;
    if (e.key === 'ArrowLeft' || e.key === 'a' || e.key === 'A') player.movingLeft = false;
    if (e.key === 'ArrowRight' || e.key === 'd' || e.key === 'D') player.movingRight = false;
  });

  canvas.addEventListener('touchstart', e => {
    if (!player || !gameActive || paused || adPlaying) return;
    e.preventDefault();
    const touch = e.touches[0];
    const rect = canvas.getBoundingClientRect();
    const touchX = touch.clientX - rect.left;
    
    if (touchX < width / 2) {
      player.movingLeft = true;
    } else {
      player.movingRight = true;
    }
  }, { passive: false });

  canvas.addEventListener('touchend', e => {
    if (!player) return;
    e.preventDefault();
    player.movingLeft = false;
    player.movingRight = false;
  }, { passive: false });
  
  canvas.addEventListener('touchmove', e => {
    e.preventDefault();
  }, { passive: false });

  document.getElementById('play-btn').onclick = startGame;
  document.getElementById('retry-btn').onclick = startGame;

  document.getElementById('store-btn').onclick = () => {
    document.getElementById('start-screen').style.display = 'none';
    document.getElementById('skin-store').style.display = 'flex';
    renderSkinStore();
  };

  document.getElementById('close-skin-store-btn').onclick = () => {
    document.getElementById('skin-store').style.display = 'none';
    document.getElementById('start-screen').style.display = 'flex';
  };

  document.getElementById('no-thanks-btn').onclick = () => {
    document.getElementById('continue-screen').style.display = 'none';
    endGame();
  };

  document.getElementById('watch-ad-btn').onclick = () => {
    if (adPlaying) return;
    adPlaying = true;
    document.getElementById('watch-ad-btn').disabled = true;
    document.getElementById('watch-ad-btn').textContent = 'Loading Ad...';

    let secondsLeft = 3;
    const interval = setInterval(() => {
      document.getElementById('watch-ad-btn').textContent = `Ad ends in ${secondsLeft--}s`;
      if (secondsLeft < 0) {
        clearInterval(interval);
        document.getElementById('continue-screen').style.display = 'none';
        
        createPlayer();
        player.shield = true;
        powerupActive = 'shield';
        powerupTimer = 150;
        
        gameActive = true;
        paused = false;
        adPlaying = false;
        continueAvailable = true;
        
        document.getElementById('watch-ad-btn').disabled = false;
        document.getElementById('watch-ad-btn').textContent = 'Watch Ad';
        if (soundOn) bgMusic.play().catch(() => {});
      }
    }, 1000);
  };

  toggleSoundBtn.onclick = () => {
    soundOn = !soundOn;
    toggleSoundBtn.textContent = soundOn ? 'üîä' : 'üîá';
    if (soundOn) {
      if (gameActive && !paused) bgMusic.play().catch(() => {});
    } else {
      bgMusic.pause();
    }
  };

  togglePauseBtn.onclick = () => {
    if (!gameActive) return;
    paused = !paused;
    togglePauseBtn.textContent = paused ? '‚ñ∂Ô∏è' : '‚è∏Ô∏è';
    if (!paused) {
      if (soundOn) bgMusic.play().catch(() => {});
    } else {
      bgMusic.pause();
    }
  };
  
  // Initial setup
  loadGameData();
  resize();
  createPlayer();
  updateDisplays();
  gameLoop();

})();
</script>
</body>
</html>
