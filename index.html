<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Puff Run - Dream Edition Super Advanced</title>
<style>
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  font-family: 'Rubik', sans-serif;
  overflow: hidden;
  color: white;
  -webkit-user-select: none; /* Disable text selection for touch devices */
  -moz-user-select: none;
  -ms-user-select: none;
  user-select: none;
  -webkit-tap-highlight-color: transparent; /* Remove tap highlight on mobile */
}

#game-canvas {
  display: block;
  margin: 0 auto;
  background: rgba(255, 255, 255, 0.05);
  border: 2px solid rgba(255, 255, 255, 0.2);
  border-radius: 15px;
  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
}

#score-display, #high-score-display, #currency-display {
  position: absolute;
  font-size: 1.5rem;
  font-weight: 700;
  color: white;
  text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
  z-index: 10;
}

#score-display {
  top: 20px;
  left: 20px;
}

#high-score-display {
  top: 20px;
  right: 20px;
}

#currency-display {
  top: 60px;
  left: 20px;
}

#level-message {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  font-size: 3rem;
  font-weight: 700;
  color: #ff6b6b;
  text-shadow: 3px 3px 6px rgba(0, 0, 0, 0.7);
  z-index: 100;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.3s ease;
}

#message-box {
  position: absolute;
  bottom: 20px;
  left: 50%;
  transform: translateX(-50%);
  font-size: 1.2rem;
  font-weight: 700;
  color: #4ecdc4;
  text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
  z-index: 10;
  opacity: 0;
  transition: opacity 0.3s ease;
}

.score-popup {
  position: absolute;
  font-size: 1.2rem;
  font-weight: 700;
  color: #feca57;
  text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.6);
  z-index: 20;
  opacity: 0;
  animation: fadeUp 1s forwards;
}

@keyframes fadeUp {
  from { opacity: 1; transform: translateY(0); }
  to { opacity: 0; transform: translateY(-50px); }
}

#toggle-sound, #toggle-pause {
  position: absolute;
  top: 70px;
  right: 20px;
  width: 40px;
  height: 40px;
  border: none;
  background: transparent;
  color: white;
  font-size: 1.2rem;
  cursor: pointer;
  z-index: 10;
}

#toggle-pause {
  right: 70px;
}

#start-screen, #game-over-screen, #continue-screen, #store-screen,
#how-to-play-screen, #daily-reward-screen, #mission-screen, #pre-game-powerup-store, #tutorial-overlay {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  background: rgba(0, 0, 0, 0.8);
  z-index: 1000;
  backdrop-filter: blur(20px);
  text-align: center;
}

#start-screen div:first-child {
  font-size: 3rem;
  font-weight: 700;
  margin-bottom: 30px;
  text-align: center;
  background: linear-gradient(45deg, #ff6b6b, #4ecdc4, #45b7d1);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  animation: pulse 2s infinite;
}

@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.7; }
}

button {
  padding: 15px 30px;
  margin: 10px;
  font-size: 1.2rem;
  font-weight: 700;
  font-family: 'Rubik', sans-serif;
  border: none;
  border-radius: 25px;
  background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
  color: white;
  cursor: pointer;
  transition: all 0.3s ease;
  box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
  -webkit-tap-highlight-color: transparent; /* For Safari on iOS */
}

button:hover {
  transform: translateY(-3px);
  box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
}

button:active {
  transform: translateY(-1px);
}

button:disabled {
  opacity: 0.6;
  cursor: not-allowed;
  transform: none;
}

#store-screen, #how-to-play-screen, #daily-reward-screen, #mission-screen, #pre-game-powerup-store {
  padding: 10px;
  overflow-y: auto; /* Allow vertical scrolling if content is too long */
  -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */
}

#store-screen h2, #how-to-play-screen h2, #daily-reward-screen h2, #mission-screen h2, #pre-game-powerup-store h2 {
  font-size: 1.8rem;
  margin-bottom: 15px;
  background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

#how-to-play-screen p {
  font-size: 0.85rem;
  max-width: 90%;
  text-align: center;
  margin-bottom: 8px;
  line-height: 1.4;
  opacity: 0.9;
}

/* Store Tab Buttons */
#store-tabs {
  display: flex;
  margin-bottom: 20px;
  width: 90%;
  max-width: 400px;
  justify-content: space-around;
  flex-wrap: wrap;
}

#store-tabs button {
  flex-grow: 1;
  margin: 5px;
  padding: 10px 15px;
  font-size: 1rem;
  border-radius: 15px;
  background: rgba(255, 255, 255, 0.1);
  box-shadow: none;
}

#store-tabs button.active {
  background: linear-gradient(45deg, #4ecdc4, #45b7d1);
  box-shadow: 0 3px 10px rgba(0, 0, 0, 0.3);
}

/* Store Sections */
.store-section {
  display: none; /* Hidden by default */
  width: 100%;
  max-width: 350px;
  padding-bottom: 20px; /* Add padding for scrollable content */
}

.store-section.active {
  display: block; /* Show active section */
}

.store-section h3 {
    margin-top: 20px;
    margin-bottom: 15px;
    background: linear-gradient(45deg, #feca57, #ff9f43);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    font-size: 1.3rem;
}


#skin-list, #coin-pack-list, #upgrade-list, #pre-game-powerup-list {
  display: grid;
  grid-template-columns: repeat(3, 1fr); /* Default to 3 columns for wider screens */
  gap: 10px;
  margin: 0 auto;
}

.skin-button, .coin-pack-button, .upgrade-button, .pre-game-powerup-button {
  width: 90px;
  height: 70px;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  text-align: center;
  border: 2px solid rgba(255, 255, 255, 0.3);
  font-size: 0.8rem;
  padding: 5px;
  background: linear-gradient(45deg, #feca57, #ff9f43);
  border-radius: 10px;
}

.skin-button .price-tag, .coin-pack-button .price-tag, .upgrade-button .price-tag, .pre-game-powerup-button .price-tag {
  font-size: 0.7rem;
  opacity: 0.9;
  margin-top: 2px;
  font-weight: bold;
}

#close-store-btn, #close-how-to-play-btn, #claim-daily-reward-btn,
#close-missions-btn, #close-pre-game-powerup-store-btn, #tutorial-close-btn {
  padding: 8px 16px;
  font-size: 1rem;
  margin-top: 20px; /* Space from content above */
}

/* Daily Reward Specific Styles */
#daily-reward-track {
  display: flex; /* Use flex for horizontal layout */
  justify-content: flex-start; /* Align items to the start */
  align-items: center;
  margin-bottom: 20px;
  overflow-x: auto; /* Enable horizontal scrolling */
  -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */
  white-space: nowrap; /* Prevent items from wrapping */
  width: 100%; /* Take full width */
  padding: 10px 0; /* Add some padding for scroll indicators */
  scroll-snap-type: x mandatory; /* Optional: for snapping effect */
}

#daily-reward-screen .daily-reward-item {
  flex: 0 0 auto; /* Prevent items from shrinking */
  display: inline-block; /* For horizontal flow */
  padding: 10px;
  margin: 0 5px; /* Adjust margin for spacing */
  border: 1px solid rgba(255, 255, 255, 0.3);
  border-radius: 8px;
  background: rgba(255, 255, 255, 0.1);
  width: 90px; /* Fixed width for consistency */
  min-width: 90px;
  text-align: center;
  scroll-snap-align: center; /* Snap to center when scrolling */
}
#daily-reward-screen .daily-reward-item.claimed {
  opacity: 0.6;
  background: rgba(255, 255, 255, 0.05);
}

/* Mission Specific Styles */
#mission-list {
  list-style: none;
  padding: 0;
  max-width: 350px;
  width: 90%; /* Ensure it adapts to screen width */
  margin: 20px auto;
}
#mission-list li {
  background: rgba(255, 255, 255, 0.1);
  padding: 10px 15px;
  margin-bottom: 10px;
  border-radius: 8px;
  display: flex;
  flex-direction: column; /* Stack content vertically on small screens */
  justify-content: space-between;
  align-items: flex-start; /* Align text to start */
  font-size: 0.9rem; /* Smaller font for missions */
}
#mission-list li.completed {
  background: rgba(78, 205, 196, 0.2);
  text-decoration: line-through;
  opacity: 0.7;
}
#mission-list li span {
  flex-grow: 1;
  text-align: left;
  margin-bottom: 5px; /* Space between description and button */
}
#mission-list li button {
  margin-left: 0; /* Remove left margin */
  padding: 5px 10px;
  font-size: 0.8rem; /* Smaller button for missions */
  width: 100%; /* Full width button */
}

/* Tutorial Overlay */
#tutorial-overlay {
    background: rgba(0, 0, 0, 0.95);
    z-index: 10000; /* Super high z-index */
}
#tutorial-overlay .tutorial-content {
    background: rgba(255, 255, 255, 0.1);
    padding: 30px;
    border-radius: 15px;
    max-width: 80%;
    margin: 20px;
    box-shadow: 0 0 30px rgba(0, 0, 0, 0.7);
}
#tutorial-overlay h2 {
    font-size: 2.5rem;
    margin-bottom: 20px;
    background: linear-gradient(45deg, #4ecdc4, #ff6b6b);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}
#tutorial-overlay p {
    font-size: 1.2rem;
    margin-bottom: 15px;
    line-height: 1.6;
}
#tutorial-overlay .tutorial-controls {
    font-size: 1.1rem;
    font-weight: bold;
    color: #feca57;
    margin-top: 20px;
}

/* --- MOBILE SPECIFIC STYLES --- */
@media (max-width: 768px) {
  #start-screen div:first-child {
    font-size: 1.8rem;
    margin-bottom: 15px;
  }
  
  #score-display, #high-score-display, #currency-display {
    font-size: 1rem;
    top: 10px;
  }
  
  #score-display {
    left: 10px;
  }
  
  #high-score-display {
    right: 10px;
  }

  #currency-display {
    top: 40px;
    left: 10px;
  }
  
  #level-message {
    font-size: 1.5rem;
  }
  
  button {
    padding: 10px 20px;
    font-size: 0.9rem;
    margin: 8px;
  }
  
  #toggle-sound, #toggle-pause {
    top: 50px;
    right: 10px;
    width: 35px;
    height: 35px;
    font-size: 1rem;
  }
  
  #toggle-pause {
    right: 50px;
  }
  
  #game-canvas {
    border-radius: 10px;
  }

  #store-screen h2, #how-to-play-screen h2, #daily-reward-screen h2, #mission-screen h2, #pre-game-powerup-store h2 {
    font-size: 1.5rem;
    margin-bottom: 10px;
  }

  #how-to-play-screen p {
    font-size: 0.75rem;
    max-width: 95%;
  }

  /* Store Tabs Mobile */
  #store-tabs {
    flex-direction: row; /* Keep row for small screens, allow wrapping */
    justify-content: center;
    width: 95%;
    max-width: none;
  }
  #store-tabs button {
    flex-basis: 45%; /* Two buttons per row approx */
    font-size: 0.85rem;
    padding: 8px 10px;
    margin: 4px;
  }

  /* Store Sections Mobile */
  .store-section h3 {
    font-size: 1.1rem;
    margin-top: 15px;
    margin-bottom: 10px;
  }

  #skin-list, #coin-pack-list, #upgrade-list, #pre-game-powerup-list {
    grid-template-columns: repeat(2, 1fr); /* Adjust grid to 2 columns for smaller screens */
    max-width: 250px; /* Constrain max width for grid containers */
    gap: 8px; /* Slightly smaller gap */
  }
  .skin-button, .coin-pack-button, .upgrade-button, .pre-game-powerup-button {
    width: 100px; /* Adjust button width to fit 2 columns */
    height: 60px;
    font-size: 0.7rem;
    padding: 3px;
  }
  .skin-button .price-tag, .coin-pack-button .price-tag, .upgrade-button .price-tag, .pre-game-powerup-button .price-tag {
    font-size: 0.6rem;
  }

  #close-store-btn {
    margin-top: 15px;
    padding: 10px 20px;
    font-size: 0.9rem;
  }


  /* Daily Reward Specific Mobile Adjustments */
  #daily-reward-screen .daily-reward-item {
    width: 80px; /* Slightly smaller width for items */
    min-width: 80px;
    font-size: 0.7rem;
    padding: 8px;
  }

  /* Mission Specific Mobile Adjustments */
  #mission-list li {
    font-size: 0.8rem;
    padding: 8px 12px;
  }
  #mission-list li button {
    font-size: 0.7rem;
    padding: 4px 8px;
  }

  /* Tutorial Overlay Mobile Adjustments */
  #tutorial-overlay .tutorial-content {
    padding: 20px;
    max-width: 90%;
    margin: 10px;
  }
  #tutorial-overlay h2 {
    font-size: 1.8rem;
    margin-bottom: 15px;
  }
  #tutorial-overlay p {
    font-size: 0.9rem;
    margin-bottom: 10px;
  }
  #tutorial-overlay .tutorial-controls {
    font-size: 0.8rem;
  }
}
</style>
<link href="https://fonts.googleapis.com/css2?family=Rubik:wght@700&display=swap" rel="stylesheet" />
</head>
<body>

<canvas id="game-canvas"></canvas>
<div id="score-display">Score: 0</div>
<div id="high-score-display"></div>
<div id="currency-display">Coins: 0</div>
<div id="level-message"></div>
<div id="message-box"></div>
<button id="toggle-sound" title="Toggle Sound">🔊</button>
<button id="toggle-pause" title="Pause/Resume">⏸️</button>

<audio id="bg-music" src="assets/audio/background_music.mp3" loop preload="auto"></audio>
<audio id="hit-sound" src="assets/audio/hit_sound.mp3" preload="auto"></audio>
<audio id="powerup-sound" src="assets/audio/powerup_sound.mp3" preload="auto"></audio>
<audio id="coin-sound" src="assets/audio/coin_sound.mp3" preload="auto"></audio>
<audio id="mission-complete-sound" src="assets/audio/mission_complete.mp3" preload="auto"></audio>

<div id="start-screen">
  <div>Welcome to Puff Run - Dream Edition</div>
  <button id="play-btn">Start Game</button>
  <button id="store-btn">💰 Store</button> 
  <button id="missions-btn">✅ Missions</button>
  <button id="daily-reward-btn">🎁 Daily Reward</button>
  <button id="how-to-play-btn">❓ How to Play</button>
  <div style="font-size: 0.9rem; margin-top: 20px; opacity: 0.7;">Use Arrow keys, A/D, or touch screen to move</div>
</div>

<div id="game-over-screen" style="display:none;">
  <div id="score-display-final"></div>
  <div id="coins-earned-display"></div>
  <button id="retry-btn">Play Again</button>
</div>

<div id="continue-screen" style="display:none;">
  <div>You hit an obstacle! Watch an ad to continue?</div>
  <button id="watch-ad-btn">Watch Ad</button>
  <button id="no-thanks-btn">No Thanks</button>
</div>

<div id="store-screen" style="display:none;">
  <h2>Store</h2> 
  <div id="store-tabs">
    <button id="tab-skins" class="active">Skins</button>
    <button id="tab-coin-packs">Coin Packs</button>
    <button id="tab-upgrades">Upgrades</button>
    <button id="tab-pre-game-boosts">Boosts</button>
  </div>

  <div id="skins-section" class="store-section active">
    <h3>Skins</h3>
    <div id="skin-list"></div>
  </div>

  <div id="coin-packs-section" class="store-section">
    <h3>Coin Packs</h3> 
    <div id="coin-pack-list"></div>
  </div>

  <div id="upgrades-section" class="store-section">
    <h3>Upgrades</h3>
    <div id="upgrade-list"></div>
  </div>

  <div id="pre-game-boosts-section" class="store-section">
    <h3>Pre-Game Boosts</h3>
    <p>Get a head start on your run!</p>
    <div id="pre-game-powerup-list"></div>
  </div>

  <button id="close-store-btn">Close</button>
</div>


<div id="how-to-play-screen" style="display:none;">
  <h2>How to Play Puff Run</h2>
  <p>Guide your dreamy sphere through a vibrant, ever-changing world. Avoid obstacles and collect power-ups to achieve the highest score!</p>
  <p><strong>Controls:</strong></p>
  <p>- Use <strong>Left/Right Arrow keys</strong> or <strong>A/D keys</strong> on keyboard.</p>
  <p>- On touch devices, tap the <strong>left or right half of the screen</strong> to move.</p>
  <p><strong>Power-ups:</strong></p>
  <p>- 🛡️ <strong>Shield:</strong> Become temporarily invincible to obstacles.</p>
  <p>- ⏳ <strong>Slow:</strong> Slow down time, making obstacles easier to dodge.</p>
  <p>- ✨ <strong>Points:</strong> Instantly gain bonus points!</p>
  <p>- 💰 <strong>Multiplier:</strong> Doubles your score gain for a short period!</p>
  <p>- 🧲 <strong>Magnet:</strong> Attracts power-ups towards you!</p>
  <button id="close-how-to-play-btn">Got It!</button>
</div>

<div id="daily-reward-screen" style="display:none;">
    <h2>Daily Reward</h2>
    <p id="daily-reward-status"></p>
    <div id="daily-reward-track"></div>
    <button id="claim-daily-reward-btn">Claim Reward</button>
    <button id="close-daily-reward-btn">Close</button>
</div>

<div id="mission-screen" style="display:none;">
    <h2>Daily Missions</h2>
    <p>Complete missions to earn extra coins!</p>
    <ul id="mission-list"></ul>
    <button id="close-missions-btn">Close</button>
</div>

<div id="tutorial-overlay" style="display:none;">
    <div class="tutorial-content">
        <h2>Welcome to Puff Run!</h2>
        <p>Your goal is simple: **DODGE** the obstacles!</p>
        <p class="tutorial-controls">
            **Move Left:** Tap left side of screen / Left Arrow or 'A' key<br>
            **Move Right:** Tap right side of screen / Right Arrow or 'D' key
        </p>
        <p>Collect **power-ups** to help you on your journey!</p>
        <button id="tutorial-close-btn">Got It! Let's Go!</button>
    </div>
</div>

<script>
(() => {
  const canvas = document.getElementById('game-canvas');
  const ctx = canvas.getContext('2d');
  const scoreDisplay = document.getElementById('score-display');
  const highScoreDisplay = document.getElementById('high-score-display');
  const currencyDisplay = document.getElementById('currency-display');
  const levelMessage = document.getElementById('level-message');
  const messageBox = document.getElementById('message-box');
  const toggleSoundBtn = document.getElementById('toggle-sound');
  const togglePauseBtn = document.getElementById('toggle-pause');
  const bgMusic = document.getElementById('bg-music');
  const hitSound = document.getElementById('hit-sound');
  const powerupSound = document.getElementById('powerup-sound');
  const coinSound = document.getElementById('coin-sound');
  const missionCompleteSound = document.getElementById('mission-complete-sound');

  // Store related elements
  const storeScreen = document.getElementById('store-screen');
  const storeTabs = document.getElementById('store-tabs');
  const skinList = document.getElementById('skin-list');
  const coinPackList = document.getElementById('coin-pack-list');
  const upgradeList = document.getElementById('upgrade-list'); 
  const preGamePowerupList = document.getElementById('pre-game-powerup-list');

  const howToPlayScreen = document.getElementById('how-to-play-screen');
  const dailyRewardScreen = document.getElementById('daily-reward-screen'); 
  const missionScreen = document.getElementById('mission-screen'); 
  const tutorialOverlay = document.getElementById('tutorial-overlay');

  let width, height;
  let gameActive = false;
  let paused = false;
  let adPlaying = false;
  let score = 0;
  let highScore = 0;
  let coins = 0;
  let currentLevel = 1;
  let obstacles = [];
  let powerups = [];
  let particles = [];
  let player = null;
  let soundOn = true;
  let continueAvailable = false;
  let powerupActive = null;
  let powerupTimer = 0;
  let scoreMultiplier = 1;
  let invincibleTimer = 0;

  // Pre-game power-up related variables
  let preGameShield = 0;
  let preGameSlow = 0;
  let preGameMultiplier = 0;

  // --- GLOBAL SPEED ADJUSTMENT ---
  const GLOBAL_SPEED_MULTIPLIER = 0.8;
  // ---------------------------------

  const skins = [
    { name: 'Classic', colors: ['#ff6b6b', '#4ecdc4'], unlocked: true, price: 0 },
    { name: 'Ocean', colors: ['#74b9ff', '#0984e3'], unlocked: false, price: 1500 },
    { name: 'Sunset', colors: ['#fd79a8', '#fdcb6e'], unlocked: false, price: 3000 },
    { name: 'Forest', colors: ['#55a3ff', '#00b894'], unlocked: false, price: 5000 },
    { name: 'Galaxy', colors: ['#a29bfe', '#6c5ce7', '#fd79a8'], unlocked: false, price: 8000 }
  ];

  const coinPacks = [
    { name: 'Small Pack', coins: 100, price: '$0.99', id: 'coin_pack_small' },
    { name: 'Medium Pack', coins: 500, price: '$3.99', id: 'coin_pack_medium' },
    { name: 'Large Pack', coins: 1500, price: '$9.99', id: 'coin_pack_large' },
    { name: 'Mega Pack', coins: 5000, price: '$24.99', id: 'coin_pack_mega' }
  ];

  // New Coin Sinks: Upgrades
  const playerUpgrades = [
    { name: 'Magnet Duration', description: '+2s Magnet Time', type: 'magnetDuration', levels: 3, currentLevel: 0, basePrice: 200, priceScale: 2 }
  ];

  // New Coin Sinks: Pre-Game Power-ups
  const preGamePowerups = [
      { name: 'Shield', type: 'shield', cost: 100, icon: '🛡️' },
      { name: 'Slow', type: 'slow', cost: 150, icon: '⏳' },
      { name: '2x Score', type: 'multiplier', cost: 200, icon: '💰' }
  ];

  // Daily Reward structure
  const dailyRewardData = [
      { day: 1, coins: 50 },
      { day: 2, coins: 100 },
      { day: 3, coins: 200 },
      { day: 4, coins: 300 },
      { day: 5, coins: 500 },
      { day: 6, coins: 750 },
      { day: 7, coins: 1000 }
  ];

  // Missions
  let missions = []; // Will be loaded/generated
  const missionTemplates = [
      { id: 'score', text: 'Reach a score of {target} in one run', target: [500, 1000, 2000], current: 0, reward: [100, 200, 300] },
      { id: 'powerupsCollected', text: 'Collect {target} power-ups in one run', target: [3, 5, 8], current: 0, reward: [75, 125, 200] },
      { id: 'coinsEarned', text: 'Earn {target} coins in one run', target: [200, 400, 600], current: 0, reward: [150, 250, 350] },
      { id: 'runsPlayed', text: 'Play {target} games', target: [2, 5, 10], current: 0, reward: [50, 100, 150] }
  ];

  let selectedSkin = skins[0];

  function resize() {
    width = window.innerWidth;
    height = window.innerHeight;
    canvas.width = width;
    canvas.height = height;
  }

  function saveGameData() {
    const data = {
      highScore: highScore,
      coins: coins,
      skins: skins.map(s => ({ name: s.name, unlocked: s.unlocked })),
      selectedSkinName: selectedSkin.name,
      lastLoginDate: localStorage.getItem('lastLoginDate'),
      dailyRewardDay: localStorage.getItem('dailyRewardDay') || 0,
      dailyRewardClaimed: localStorage.getItem('dailyRewardClaimed') === 'true',
      playerUpgrades: playerUpgrades.map(u => ({ name: u.name, currentLevel: u.currentLevel })),
      missions: missions,
      hasSeenTutorial: localStorage.getItem('hasSeenTutorial') === 'true',
      preGameShield: preGameShield, // Save pre-game boosts
      preGameSlow: preGameSlow,
      preGameMultiplier: preGameMultiplier
    };
    try {
      localStorage.setItem('puffRunGameData', JSON.stringify(data));
    } catch (e) {
      console.error('Failed to save game data to local storage:', e);
    }
  }

  function loadGameData() {
    try {
      const storedData = localStorage.getItem('puffRunGameData');
      if (storedData) {
        const data = JSON.parse(storedData);
        highScore = data.highScore || 0;
        coins = data.coins || 0;
        
        if (data.skins) {
          data.skins.forEach(loadedSkin => {
            const existingSkin = skins.find(s => s.name === loadedSkin.name);
            if (existingSkin) {
              existingSkin.unlocked = loadedSkin.unlocked;
            }
          });
        }
        if (data.selectedSkinName) {
          const found = skins.find(s => s.name === data.selectedSkinName);
          if (found && found.unlocked) {
            selectedSkin = found;
          } else {
            selectedSkin = skins[0];
          }
        }

        localStorage.setItem('lastLoginDate', data.lastLoginDate || '');
        localStorage.setItem('dailyRewardDay', data.dailyRewardDay || 0);
        localStorage.setItem('dailyRewardClaimed', data.dailyRewardClaimed ? 'true' : 'false');
        
        if (data.playerUpgrades) {
            data.playerUpgrades.forEach(loadedUpgrade => {
                const existingUpgrade = playerUpgrades.find(u => u.name === loadedUpgrade.name);
                if (existingUpgrade) {
                    existingUpgrade.currentLevel = loadedUpgrade.currentLevel;
                }
            });
        }

        if (data.missions && data.missions.length > 0) {
            missions = data.missions;
        } else {
            generateNewMissions();
        }
        
        localStorage.setItem('hasSeenTutorial', data.hasSeenTutorial ? 'true' : 'false');

        preGameShield = data.preGameShield || 0; // Load pre-game boosts
        preGameSlow = data.preGameSlow || 0;
        preGameMultiplier = data.preGameMultiplier || 0;

      } else {
          generateNewMissions();
      }
    } catch (e) {
      console.error('Failed to load game data from local storage:', e);
      localStorage.removeItem('puffRunGameData');
      generateNewMissions(); 
    }
  }

  function createPlayer() {
    player = {
      x: width / 2,
      y: height - 75,
      radius: 26,
      velocityX: 0,
      acceleration: 0.7 * GLOBAL_SPEED_MULTIPLIER,
      maxSpeed: (5 + currentLevel * 0.07) * GLOBAL_SPEED_MULTIPLIER,
      friction: 0.85, 
      colors: selectedSkin.colors,
      shield: false,
      shieldAlpha: 0,
      movingLeft: false,
      movingRight: false,
      invincible: false, 
      invincibleTimer: 0 
    };

    // Apply pre-game power-ups
    if (preGameShield > 0) {
        activatePowerup('shield');
        powerupTimer = 300 * (1 / GLOBAL_SPEED_MULTIPLIER); // 5 seconds
        preGameShield--;
        showMessage("Shield boost consumed!");
        saveGameData();
    }
    if (preGameSlow > 0) {
        activatePowerup('slow');
        powerupTimer = 300 * (1 / GLOBAL_SPEED_MULTIPLIER); // 5 seconds
        preGameSlow--;
        showMessage("Slow boost consumed!");
        saveGameData();
    }
    if (preGameMultiplier > 0) {
        activatePowerup('multiplier');
        powerupTimer = 300 * (1 / GLOBAL_SPEED_MULTIPLIER); // 5 seconds
        preGameMultiplier--;
        showMessage("Score boost consumed!");
        saveGameData();
    }
  }

  function drawBackground() {
    const time = Date.now() * 0.002;
    
    const gradient = ctx.createLinearGradient(0, 0, 0, height);
    gradient.addColorStop(0, '#667eea');
    gradient.addColorStop(0.3, '#764ba2');
    gradient.addColorStop(0.7, '#5f27cd');
    gradient.addColorStop(1, '#341f97');
    ctx.fillStyle = gradient;
    ctx.fillRect(0, 0, width, height);

    for (let i = 0; i < 200; i++) {
      const x = (Math.sin(time + i * 0.1) * 50 + width * (i % 7) / 7);
      const y = (Math.cos(time * 0.5 + i * 0.2) * 30 + height * (i % 5) / 5);
      const size = Math.sin(time + i * 0.3) * 2 + 3;
      const alpha = Math.sin(time + i * 0.15) * 0.3 + 0.4;
      
      ctx.save();
      ctx.globalAlpha = alpha;
      ctx.fillStyle = i % 3 === 0 ? '#ff6b6b' : i % 3 === 1 ? '#4ecdc4' : '#feca57';
      ctx.beginPath();
      ctx.arc(x, y, size, 0, Math.PI * 2);
      ctx.fill();
      ctx.restore();
    }

    for (let i = 0; i < 50; i++) {
      const x = (Math.sin(time * 0.3 + i * 0.5) * 100 + width / 2);
      const y = (Math.cos(time * 0.4 + i * 0.3) * 80 + height / 2);
      const rotation = time + i * 0.1;
      const size = Math.sin(time + i * 0.2) * 15 + 20;
      
      ctx.save();
      ctx.translate(x, y);
      ctx.rotate(rotation);
      ctx.globalAlpha = 0.1;
      
      const starGradient = ctx.createRadialGradient(0, 0, 0, 0, 0, size);
      starGradient.addColorStop(0, '#ffffff');
      starGradient.addColorStop(1, 'transparent');
      ctx.fillStyle = starGradient;
      
      ctx.beginPath();
      for (let j = 0; j < 5; j++) {
        const angle = (j * Math.PI * 2) / 5;
        const x1 = Math.cos(angle) * size;
        const y1 = Math.sin(angle) * size;
        const x2 = Math.cos(angle + Math.PI / 5) * size * 0.5;
        const y2 = Math.sin(angle + Math.PI / 5) * size * 0.5;
        
        if (j === 0) ctx.moveTo(x1, y1);
        else ctx.lineTo(x1, y1);
        ctx.lineTo(x2, y2);
      }
      ctx.closePath();
      ctx.fill();
      ctx.restore();
    }
  }

  function drawPlayer() {
    if (!player) return;

    ctx.save();
    ctx.translate(player.x, player.y);

    if (player.shield) {
      ctx.globalAlpha = player.shieldAlpha;
      ctx.strokeStyle = '#4ecdc4';
      ctx.lineWidth = 4;
      ctx.beginPath();
      ctx.arc(0, 0, player.radius + 10, 0, Math.PI * 2);
      ctx.stroke();
    }

    if (player.invincible) {
        ctx.globalAlpha = (Math.sin(player.invincibleTimer * 0.5) * 0.5) + 0.5;
    } else {
        ctx.globalAlpha = 1;
    }
    
    const gradient = ctx.createRadialGradient(0, 0, 0, 0, 0, player.radius);
    if (player.colors.length === 3) {
      gradient.addColorStop(0, player.colors[0]);
      gradient.addColorStop(0.5, player.colors[1]);
      gradient.addColorStop(1, player.colors[2]);
    } else {
      gradient.addColorStop(0, player.colors[0]);
      gradient.addColorStop(1, player.colors[1]);
    }
    
    ctx.fillStyle = gradient;
    ctx.beginPath();
    ctx.arc(0, 0, player.radius, 0, Math.PI * 2);
    ctx.fill();

    ctx.fillStyle = 'rgba(255, 255, 255, 0.3)';
    ctx.beginPath();
    ctx.arc(-8, -8, player.radius * 0.3, 0, Math.PI * 2);
    ctx.fill();

    ctx.restore();

    if (Math.abs(player.velocityX) > 0.5) { 
        const stretchFactor = 1 + Math.min(0.2, Math.abs(player.velocityX) / player.maxSpeed * 0.5);
        const squashFactor = 1 - Math.min(0.2, Math.abs(player.velocityX) / player.maxSpeed * 0.5);
        ctx.save();
        ctx.translate(player.x, player.y);
        ctx.scale(stretchFactor, squashFactor);
        ctx.fillStyle = gradient;
        ctx.beginPath();
        ctx.arc(0, 0, player.radius, 0, Math.PI * 2);
        ctx.fill();
        ctx.restore();
    }
  }

  function drawObstacles() {
    obstacles.forEach(obstacle => {
      ctx.save();
      ctx.translate(obstacle.x + obstacle.width/2, obstacle.y + obstacle.height/2);
      ctx.rotate(obstacle.rotation);
      
      const gradient = ctx.createRadialGradient(0, 0, 0, 0, 0, obstacle.width/2);
      gradient.addColorStop(0, obstacle.color);
      gradient.addColorStop(1, '#2d3436');
      ctx.fillStyle = gradient;
      
      if (obstacle.type === 'circle') {
        ctx.beginPath();
        ctx.arc(0, 0, obstacle.width/2, 0, Math.PI * 2);
        ctx.fill();
      } else if (obstacle.type === 'triangle') {
        ctx.beginPath();
        ctx.moveTo(0, -obstacle.height/2);
        ctx.lineTo(-obstacle.width/2, obstacle.height/2);
        ctx.lineTo(obstacle.width/2, obstacle.height/2);
        ctx.closePath();
        ctx.fill();
      } else if (obstacle.type === 'star') { 
        const outerRadius = obstacle.width / 2;
        const innerRadius = outerRadius * 0.4;
        ctx.beginPath();
        for (let j = 0; j < 5; j++) {
          const outerAngle = (j * Math.PI * 2) / 5 - Math.PI / 2;
          const innerAngle = outerAngle + Math.PI / 5;
          if (j === 0) ctx.moveTo(Math.cos(outerAngle) * outerRadius, Math.sin(outerAngle) * outerRadius);
          else ctx.lineTo(Math.cos(outerAngle) * outerRadius, Math.sin(outerAngle) * outerRadius);
          ctx.lineTo(Math.cos(innerAngle) * innerRadius, Math.sin(innerAngle) * innerRadius);
        }
        ctx.closePath();
        ctx.fill();
      } else { 
        ctx.beginPath();
        ctx.roundRect(-obstacle.width/2, -obstacle.height/2, obstacle.width, obstacle.height, 8);
        ctx.fill();
      }
      
      ctx.strokeStyle = 'rgba(255, 255, 255, 0.3)';
      ctx.lineWidth = 2;
      ctx.stroke();
      
      ctx.restore();
      obstacle.rotation += 0.05;
    });
  }

  function drawPowerups() {
    powerups.forEach(powerup => {
      ctx.save();
      ctx.translate(powerup.x + powerup.size/2, powerup.y + powerup.size/2);
      ctx.rotate(powerup.rotation);
      
      ctx.fillStyle = powerup.color;
      ctx.fillRect(-powerup.size/2, -powerup.size/2, powerup.size, powerup.size);

      ctx.fillStyle = 'rgba(255, 255, 255, 0.9)';
      ctx.font = `${powerup.size * 0.7}px Arial`; 
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      let icon = '';
      if (powerup.type === 'shield') icon = '🛡️';
      else if (powerup.type === 'slow') icon = '⏳';
      else if (powerup.type === 'points') icon = '✨';
      else if (powerup.type === 'multiplier') icon = '💰'; 
      else if (powerup.type === 'magnet') icon = '🧲'; 
      ctx.fillText(icon, 0, 0);
      
      ctx.restore();
      powerup.rotation += 0.1;
    });
  }

  function drawParticles() {
    particles.forEach((particle, index) => {
      ctx.save();
      ctx.globalAlpha = particle.alpha;
      ctx.fillStyle = particle.color;
      ctx.beginPath();
      ctx.arc(particle.x, particle.y, particle.size, 0, Math.PI * 2);
      ctx.fill();
      ctx.restore();

      particle.x += particle.velocityX;
      particle.y += particle.velocityY;
      particle.alpha -= 0.02;
      particle.size *= 0.98;

      if (particle.alpha <= 0) {
        particles.splice(index, 1);
      }
    });
  }

  function createScorePopup(x, y, value) {
    const popup = document.createElement('div');
    popup.textContent = `+${value}`;
    popup.className = 'score-popup';
    popup.style.left = `${x}px`;
    popup.style.top = `${y}px`;
    document.body.appendChild(popup);

    setTimeout(() => {
      popup.remove();
    }, 1000);
  }

  function spawnObstacle() {
    const types = ['circle', 'triangle', 'rect', 'star']; 
    const type = types[Math.floor(Math.random() * types.length)];
    const colors = ['#ff6b6b', '#e17055', '#d63031'];
    
    const speedVariation = 0.7 + Math.random() * 0.6; 
    const sizeVariation = 0.8 + Math.random() * 0.4; 
    const obstacleWidth = (30 + Math.random() * 20) * sizeVariation;
    const obstacleHeight = (30 + Math.random() * 20) * sizeVariation;

    const obstacleSpeed = (1.2 + currentLevel * 0.15 + score / 2000) * speedVariation * GLOBAL_SPEED_MULTIPLIER;

    let initialVelocityX = 0;
    let oscillate = false;
    let accelerateY = false;

    if (currentLevel >= 3 || score >= 1000) {
        if (Math.random() < 0.3) { 
            oscillate = true;
            initialVelocityX = (Math.random() - 0.5) * (1 + currentLevel * 0.05) * GLOBAL_SPEED_MULTIPLIER;
        }
    }
    if (currentLevel >= 5 || score >= 2500) {
        if (Math.random() < 0.2) {
            accelerateY = true;
        }
    }

    obstacles.push({
      x: Math.random() * (width - obstacleWidth),
      y: -obstacleHeight,
      width: obstacleWidth,
      height: obstacleHeight,
      speed: obstacleSpeed,
      initialSpeed: obstacleSpeed,
      type: type,
      color: colors[Math.floor(Math.random() * colors.length)],
      rotation: 0,
      velocityX: initialVelocityX,
      oscillate: oscillate,
      oscillatePhase: Math.random() * Math.PI * 2,
      accelerateY: accelerateY,
      accelerationY: (0.01 + currentLevel * 0.001) * GLOBAL_SPEED_MULTIPLIER
    });
  }

  function spawnPowerup() {
    const types = ['shield', 'slow', 'points', 'multiplier', 'magnet']; 
    const type = types[Math.floor(Math.random() * types.length)];
    const colors = { shield: '#4ecdc4', slow: '#45b7d1', points: '#f39c12', multiplier: '#8e44ad', magnet: '#c0392b' }; 
    
    powerups.push({
      x: Math.random() * (width - 40),
      y: -30,
      size: 25,
      speed: (0.9 + currentLevel * 0.12 + score / 3000) * GLOBAL_SPEED_MULTIPLIER,
      type: type,
      color: colors[type],
      rotation: 0
    });
  }

  function checkCollisions() {
    if (!player) return;

    obstacles.forEach((obstacle, index) => {
      if (player.invincible) return; 

      const dx = player.x - (obstacle.x + obstacle.width / 2);
      const dy = player.y - (obstacle.y + obstacle.height / 2);
      const distance = Math.sqrt(dx * dx + dy * dy);
      
      if (distance < player.radius + obstacle.width / 2) {
        createParticles(player.x, player.y, '#ff6b6b', 15);
        if (soundOn) hitSound.play().catch(() => {});
        
        player.invincible = true;
        player.invincibleTimer = 60 * (1 / GLOBAL_SPEED_MULTIPLIER);
        
        completeMission('hitObstacles'); 

        setTimeout(() => {
          if (!continueAvailable) {
            continueAvailable = true;
            gameActive = false;
            document.getElementById('continue-screen').style.display = 'flex';
          } else {
            endGame();
          }
        }, 1000 * (1 / GLOBAL_SPEED_MULTIPLIER));
      }
    });

    powerups.forEach((powerup, index) => {
      const dx = player.x - (powerup.x + powerup.size / 2);
      const dy = player.y - (powerup.y + powerup.size / 2);
      const distance = Math.sqrt(dx * dx + dy * dy);
      
      if (distance < player.radius + powerup.size / 2) {
        createParticles(powerup.x, powerup.y, powerup.color, 8);
        if (soundOn) powerupSound.play().catch(() => {});
        
        activatePowerup(powerup.type);
        powerups.splice(index, 1);
        completeMission('powerupsCollected', 1);
      }
    });
  }

  function activatePowerup(type) {
    if (powerupActive && powerupActive !== 'points' && type !== 'points') {
        powerupTimer = 300 * (1 / GLOBAL_SPEED_MULTIPLIER);
        showMessage(`${type.charAt(0).toUpperCase() + type.slice(1)} Powerup Extended!`);
        return;
    }

    powerupActive = type;
    
    let baseDuration = 300; 
    if (type === 'magnet') {
        const magnetUpgrade = playerUpgrades.find(u => u.type === 'magnetDuration');
        if (magnetUpgrade) {
            baseDuration += (magnetUpgrade.currentLevel * 120);
        }
    }
    powerupTimer = baseDuration * (1 / GLOBAL_SPEED_MULTIPLIER);
    
    switch (type) {
      case 'shield':
        player.shield = true;
        player.shieldAlpha = 0.8;
        showMessage('Shield Active!');
        break;
      case 'slow':
        obstacles.forEach(obs => obs.speed *= 0.5); 
        showMessage('Time Slowed!');
        break;
      case 'points':
        score += 50;
        createScorePopup(player.x, player.y - player.radius - 20, 50); 
        showMessage('+50 Points!');
        powerupActive = null; 
        break;
      case 'multiplier': 
        scoreMultiplier = 2;
        showMessage('2x Score Multiplier!');
        break;
      case 'magnet': 
        showMessage('Magnet Active!');
        break;
    }
  }

  function updatePowerups() {
    if (powerupActive && powerupTimer > 0) {
      powerupTimer--;
      
      if (powerupActive === 'shield' && player.shield) {
        player.shieldAlpha = Math.sin(powerupTimer * 0.2) * 0.3 + 0.5;
      }
      
      if (powerupActive === 'magnet') { 
        powerups.forEach(p => {
          const dx = player.x - (p.x + p.size/2);
          const dy = player.y - (p.y + p.size/2);
          const angle = Math.atan2(dy, dx);
          const distance = Math.sqrt(dx*dx + dy*dy);
          if (distance > 20) { 
            p.x += Math.cos(angle) * Math.min(7, distance / 10) * GLOBAL_SPEED_MULTIPLIER;
            p.y += Math.sin(angle) * Math.min(7, distance / 10) * GLOBAL_SPEED_MULTIPLIER; 
          }
        });
      }

      if (powerupTimer === 0) {
        if (powerupActive === 'shield') {
          player.shield = false;
          player.shieldAlpha = 0;
        } else if (powerupActive === 'slow') {
          obstacles.forEach(obs => obs.speed *= 2); 
        } else if (powerupActive === 'multiplier') {
          scoreMultiplier = 1;
        }
        powerupActive = null;
      }
    }
  }

  function showMessage(text) {
    messageBox.textContent = text;
    messageBox.style.opacity = '1';
    setTimeout(() => {
      messageBox.style.opacity = '0';
    }, 2000 * (1 / GLOBAL_SPEED_MULTIPLIER));
  }

  function showLevelMessage(level) {
    levelMessage.textContent = `Level ${level}`;
    levelMessage.style.opacity = '1';
    setTimeout(() => {
      levelMessage.style.opacity = '0';
    }, 2000 * (1 / GLOBAL_SPEED_MULTIPLIER));
  }

  function updateGame() {
    if (!player) return;

    if (player.invincibleTimer > 0) {
        player.invincibleTimer--;
        if (player.invincibleTimer === 0) {
            player.invincible = false;
        }
    }

    if (player.movingLeft) {
      player.velocityX -= player.acceleration;
    }
    if (player.movingRight) {
      player.velocityX += player.acceleration;
    }

    player.velocityX *= player.friction;
    player.velocityX = Math.max(-player.maxSpeed, Math.min(player.maxSpeed, player.velocityX));
    
    player.x += player.velocityX;
    player.x = Math.max(player.radius, Math.min(width - player.radius, player.x));

    obstacles.forEach((obstacle, index) => {
      if (obstacle.accelerateY) {
          obstacle.speed += obstacle.accelerationY;
      }
      obstacle.y += obstacle.speed;

      if (obstacle.oscillate) {
          obstacle.x += obstacle.velocityX * Math.sin(obstacle.oscillatePhase);
          obstacle.oscillatePhase += 0.05 * GLOBAL_SPEED_MULTIPLIER;
          if (obstacle.x < 0) {
            obstacle.x = 0;
            obstacle.oscillatePhase += Math.PI;
          }
          if (obstacle.x + obstacle.width > width) {
            obstacle.x = width - obstacle.width;
            obstacle.oscillatePhase += Math.PI;
          }
      } else {
        obstacle.x += obstacle.velocityX; 
        if (obstacle.x < 0 || obstacle.x + obstacle.width > width) {
          obstacle.velocityX *= -1; 
        }
      }

      if (obstacle.y > height) {
        obstacles.splice(index, 1);
        score += (10 * scoreMultiplier); 
        if (soundOn) coinSound.play().catch(() => {});
        
        completeMission('score', score);
        completeMission('coinsEarned', coins); // Pass current total coins
      }
    });

    powerups.forEach((powerup, index) => {
      powerup.y += powerup.speed;
      if (powerup.y > height) {
        powerups.splice(index, 1);
      }
    });

    const obstacleSpawnRate = (0.009 + currentLevel * 0.0009 + score / 100000) * GLOBAL_SPEED_MULTIPLIER;
    if (Math.random() < obstacleSpawnRate) {
      spawnObstacle();
    }

    const powerupSpawnRate = (0.0028 + currentLevel * 0.0001 + score / 200000) * GLOBAL_SPEED_MULTIPLIER;
    if (Math.random() < powerupSpawnRate) { 
      spawnPowerup();
    }

    const newLevel = Math.floor(score / 200) + 1;
    if (newLevel > currentLevel) {
      currentLevel = newLevel;
      showLevelMessage(currentLevel);
      player.maxSpeed = (5 + currentLevel * 0.07) * GLOBAL_SPEED_MULTIPLIER; 
    }

    updatePowerups();
    checkCollisions();
    
    scoreDisplay.textContent = `Score: ${score}`;
  }

  function update() {
    if (!gameActive || paused || adPlaying) {
        if (paused) {
            ctx.clearRect(0, 0, width, height);
            drawBackground();
            drawPlayer();
            drawObstacles();
            drawPowerups();
            drawParticles();
        }
        requestAnimationFrame(update);
        return;
    }

    ctx.clearRect(0, 0, width, height);
    drawBackground();
    drawPlayer();
    drawObstacles();
    drawPowerups();
    drawParticles();
    
    updateGame();
    
    requestAnimationFrame(update);
  }

  function startGame() {
    score = 0;
    currentLevel = 1;
    obstacles = [];
    powerups = [];
    particles = [];
    createPlayer();
    gameActive = true;
    paused = false;
    continueAvailable = false;
    adPlaying = false;
    powerupActive = null;
    powerupTimer = 0;
    scoreMultiplier = 1; 
    player.invincible = false; 
    player.invincibleTimer = 0; 

    completeMission('runsPlayed', 1);

    document.getElementById('start-screen').style.display = 'none';
    document.getElementById('game-over-screen').style.display = 'none';
    document.getElementById('continue-screen').style.display = 'none';
    document.getElementById('how-to-play-screen').style.display = 'none'; 
    storeScreen.style.display = 'none'; // Ensure store screen is hidden
    document.getElementById('daily-reward-screen').style.display = 'none'; 
    document.getElementById('mission-screen').style.display = 'none'; 
    
    if (soundOn) {
      bgMusic.volume = 0.4;
      bgMusic.play().catch(() => {});
    }
    
    updateHighScoreDisplays();
    updateCurrencyDisplay(); 
    requestAnimationFrame(update);
  }

  function endGame() {
    gameActive = false;
    const coinsEarned = Math.floor(score / 50); 
    coins += coinsEarned; 
    if (score > highScore) {
      highScore = score;
    }
    document.getElementById('score-display-final').textContent = `Score: ${score}`;
    document.getElementById('coins-earned-display').textContent = `Coins Earned: ${coinsEarned}`; 
    document.getElementById('game-over-screen').style.display = 'flex';
    bgMusic.pause();
    saveGameData(); 
    updateHighScoreDisplays();
    updateCurrencyDisplay(); 
    
    completeMission('score', score);
    completeMission('coinsEarned', coinsEarned); 
  }

  function renderSkinStore() {
    skinList.innerHTML = '';
    skins.forEach(skin => {
      const btn = document.createElement('button');
      btn.className = 'skin-button'; 
      if (skin.colors.length === 3) {
        btn.style.background = `radial-gradient(circle at center, ${skin.colors.join(',')})`;
      } else {
        btn.style.background = `linear-gradient(135deg, ${skin.colors[0]}, ${skin.colors[1]})`;
      }
      btn.innerHTML = `${skin.name}<br><span class="price-tag">${skin.unlocked ? '✔️ Owned' : `${skin.price} Coins`}</span>`;
      
      if (!skin.unlocked && skin.price > 0) {
        btn.disabled = coins < skin.price; 
        btn.onclick = () => {
          if (confirm(`Buy ${skin.name} for ${skin.price} Coins?`)) {
            if (coins >= skin.price) {
              coins -= skin.price;
              skin.unlocked = true;
              selectedSkin = skin;
              saveGameData();
              renderSkinStore();
              updateCurrencyDisplay();
              showMessage(`Purchased ${skin.name}!`);
            } else {
              showMessage('Not enough coins!');
            }
          }
        };
      } else {
        btn.onclick = () => {
          selectedSkin = skin;
          saveGameData();
          storeScreen.style.display = 'none';
          document.getElementById('start-screen').style.display = 'flex';
          showMessage(`Selected ${skin.name} skin.`);
        };
      }
      skinList.appendChild(btn);
    });
  }

  function renderCoinPacks() {
    coinPackList.innerHTML = '';
    coinPacks.forEach(pack => {
      const btn = document.createElement('button');
      btn.className = 'coin-pack-button'; 
      btn.innerHTML = `${pack.coins} Coins<br><span class="price-tag">${pack.price}</span>`;
      btn.onclick = () => {
        if (confirm(`Simulate purchase of ${pack.coins} coins for ${pack.price}?`)) {
          coins += pack.coins;
          saveGameData();
          updateCurrencyDisplay();
          showMessage(`Purchased ${pack.coins} coins!`);
          renderSkinStore(); // Re-render skins to update buyable status
          renderUpgrades(); // Re-render upgrades to update buyable status
          renderPreGamePowerups(); // Re-render pre-game powerups to update buyable status
        }
      };
      coinPackList.appendChild(btn);
    });
  }

  function renderUpgrades() {
      upgradeList.innerHTML = '';
      playerUpgrades.forEach(upgrade => {
          const btn = document.createElement('button');
          btn.className = 'upgrade-button';
          const nextPrice = upgrade.basePrice * Math.pow(upgrade.priceScale, upgrade.currentLevel);
          const maxLevel = upgrade.currentLevel >= upgrade.levels;

          btn.innerHTML = `${upgrade.name}<br>Level: ${upgrade.currentLevel}/${upgrade.levels}<br><span class="price-tag">${maxLevel ? 'MAX' : `${nextPrice} Coins`}</span>`;
          btn.disabled = maxLevel || coins < nextPrice;

          btn.onclick = () => {
              if (!maxLevel && coins >= nextPrice) {
                  if (confirm(`Upgrade ${upgrade.name} for ${nextPrice} Coins?`)) {
                      coins -= nextPrice;
                      upgrade.currentLevel++;
                      saveGameData();
                      updateCurrencyDisplay();
                      renderUpgrades();
                      showMessage(`Upgraded ${upgrade.name}!`);
                  }
              } else if (maxLevel) {
                  showMessage('Upgrade is already max level!');
              } else {
                  showMessage('Not enough coins for upgrade!');
              }
          };
          upgradeList.appendChild(btn);
      });
  }

  function renderPreGamePowerups() {
      preGamePowerupList.innerHTML = '';
      preGamePowerups.forEach(powerup => {
          const btn = document.createElement('button');
          btn.className = 'pre-game-powerup-button';
          let currentCount;
          if (powerup.type === 'shield') currentCount = preGameShield;
          else if (powerup.type === 'slow') currentCount = preGameSlow;
          else if (powerup.type === 'multiplier') currentCount = preGameMultiplier;
          
          btn.innerHTML = `${powerup.icon} ${powerup.name}<br><span class="price-tag">${powerup.cost} Coins</span><br>Qty: ${currentCount}`;
          btn.disabled = coins < powerup.cost;

          btn.onclick = () => {
              if (coins >= powerup.cost) {
                  if (confirm(`Buy ${powerup.name} for ${powerup.cost} Coins?`)) {
                      coins -= powerup.cost;
                      if (powerup.type === 'shield') preGameShield++;
                      else if (powerup.type === 'slow') preGameSlow++;
                      else if (powerup.type === 'multiplier') preGameMultiplier++;
                      saveGameData();
                      updateCurrencyDisplay();
                      renderPreGamePowerups();
                      showMessage(`Purchased 1 ${powerup.name} boost!`);
                  }
              } else {
                  showMessage('Not enough coins!');
              }
          };
          preGamePowerupList.appendChild(btn);
      });
  }

  function updateHighScoreDisplays() {
    highScoreDisplay.textContent = `High Score: ${highScore}`;
    if (document.getElementById('score-display-final')) {
      document.getElementById('score-display-final').textContent = `Score: ${score}`;
    }
  }

  function updateCurrencyDisplay() { 
    currencyDisplay.textContent = `Coins: ${coins}`;
  }

  // Daily Reward Functions
  function checkDailyReward() {
      const lastLoginDateStr = localStorage.getItem('lastLoginDate');
      let dailyRewardDay = parseInt(localStorage.getItem('dailyRewardDay') || '0');
      let dailyRewardClaimed = localStorage.getItem('dailyRewardClaimed') === 'true';

      const today = new Date();
      today.setHours(0, 0, 0, 0);

      let lastLoginDate = null;
      if (lastLoginDateStr) {
          lastLoginDate = new Date(lastLoginDateStr);
          lastLoginDate.setHours(0, 0, 0, 0);
      }

      // If no last login, or it's a new day (diffDays >= 1)
      if (!lastLoginDate || today.getTime() > lastLoginDate.getTime()) {
          if (lastLoginDate && (today.getTime() - lastLoginDate.getTime()) / (1000 * 60 * 60 * 24) > 1.5) { // More than 1.5 days means a break in streak
              dailyRewardDay = 0; // Reset streak
          }
          localStorage.setItem('dailyRewardDay', dailyRewardDay); // Update in case streak reset
          localStorage.setItem('dailyRewardClaimed', 'false'); // Unclaim for today
          localStorage.setItem('lastLoginDate', today.toISOString()); // Set last login to today
      }

      if (localStorage.getItem('dailyRewardClaimed') === 'false') {
          document.getElementById('daily-reward-btn').style.background = 'linear-gradient(45deg, #feca57, #ff9f43)';
      } else {
          document.getElementById('daily-reward-btn').style.background = '';
      }
      saveGameData(); // Ensure state is saved
  }

  function showDailyReward() {
      document.getElementById('start-screen').style.display = 'none';
      dailyRewardScreen.style.display = 'flex';

      const dailyRewardDay = parseInt(localStorage.getItem('dailyRewardDay') || '0');
      const dailyRewardClaimed = localStorage.getItem('dailyRewardClaimed') === 'true';
      const statusText = document.getElementById('daily-reward-status');
      const claimBtn = document.getElementById('claim-daily-reward-btn');
      const rewardTrack = document.getElementById('daily-reward-track');
      rewardTrack.innerHTML = '';

      // Populate all 7 days for the track, highlighting current/claimed
      dailyRewardData.forEach((reward, index) => {
          const item = document.createElement('div');
          item.className = 'daily-reward-item';
          
          if (index < dailyRewardDay) { // Days already passed in the streak
              item.classList.add('claimed'); 
          } else if (index === dailyRewardDay && dailyRewardClaimed) { // Current day, and claimed
              item.classList.add('claimed');
          }
          
          item.innerHTML = `Day ${reward.day}<br>${reward.coins} Coins`;
          rewardTrack.appendChild(item);
      });

      if (dailyRewardDay < dailyRewardData.length && !dailyRewardClaimed) {
          statusText.textContent = `Claim your Day ${dailyRewardDay + 1} reward!`;
          claimBtn.disabled = false;
      } else {
          statusText.textContent = `You've claimed today's reward. Come back tomorrow!`;
          claimBtn.disabled = true;
          document.getElementById('daily-reward-btn').style.background = '';
      }
      
      // Auto-scroll to the current day if possible
      setTimeout(() => {
          const currentDayElement = rewardTrack.children[dailyRewardDay];
          if (currentDayElement) {
              currentDayElement.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
          }
      }, 100); 
  }

  document.getElementById('claim-daily-reward-btn').onclick = () => {
      let dailyRewardDay = parseInt(localStorage.getItem('dailyRewardDay') || '0');
      const dailyRewardClaimed = localStorage.getItem('dailyRewardClaimed') === 'true';

      if (!dailyRewardClaimed) { 
          const rewardIndex = dailyRewardDay % dailyRewardData.length; 
          const reward = dailyRewardData[rewardIndex];
          coins += reward.coins;
          updateCurrencyDisplay();
          showMessage(`Claimed ${reward.coins} coins!`);
          
          localStorage.setItem('dailyRewardDay', dailyRewardDay + 1);
          localStorage.setItem('dailyRewardClaimed', 'true');
          localStorage.setItem('lastLoginDate', new Date().toISOString()); 
          saveGameData();
          showDailyReward(); 
          if (soundOn) coinSound.play().catch(() => {});
      } else {
          showMessage('Already claimed today\'s reward!');
      }
  };
  document.getElementById('close-daily-reward-btn').onclick = () => {
      dailyRewardScreen.style.display = 'none';
      document.getElementById('start-screen').style.display = 'flex';
      checkDailyReward();
  };

  // Mission Functions
  function generateNewMissions() {
      missions = [];
      const shuffledTemplates = [...missionTemplates].sort(() => 0.5 - Math.random());
      
      for (let i = 0; i < 3; i++) {
          const template = shuffledTemplates[i % shuffledTemplates.length];
          const levelIndex = Math.floor(Math.random() * template.target.length);
          const target = template.target[levelIndex];
          const reward = template.reward[levelIndex];
          missions.push({
              id: template.id,
              description: template.text.replace('{target}', target),
              target: target,
              currentProgress: 0,
              reward: reward,
              completed: false
          });
      }
      localStorage.setItem('lastMissionReset', new Date().toISOString());
      saveGameData();
  }

  function resetMissionsDaily() {
      const lastResetDateStr = localStorage.getItem('lastMissionReset');
      if (!lastResetDateStr) {
          generateNewMissions();
          return;
      }
      const lastResetDate = new Date(lastResetDateStr);
      lastResetDate.setHours(0, 0, 0, 0);

      const today = new Date();
      today.setHours(0, 0, 0, 0);

      if (today.getTime() > lastResetDate.getTime()) {
          generateNewMissions();
      }
  }

  function updateMissionsDisplay() {
      const missionListEl = document.getElementById('mission-list');
      missionListEl.innerHTML = '';
      missions.forEach((mission, index) => {
          const li = document.createElement('li');
          li.className = mission.completed ? 'completed' : '';
          
          let progressText = '';
          if (mission.id === 'score' || mission.id === 'coinsEarned') {
              progressText = ` (${mission.currentProgress}/${mission.target})`;
          } else if (mission.id === 'powerupsCollected' || mission.id === 'runsPlayed') {
              progressText = ` (${mission.currentProgress}/${mission.target})`;
          }

          li.innerHTML = `
              <span>${mission.description}${progressText}</span>
              ${mission.completed ? `<button disabled>Claimed</button>` : `<button data-index="${index}" ${mission.currentProgress >= mission.target ? '' : 'disabled'}>Claim ${mission.reward} Coins</button>`}
          `;
          missionListEl.appendChild(li);
      });

      missionListEl.querySelectorAll('button[data-index]').forEach(button => {
          button.onclick = (e) => {
              const index = parseInt(e.target.dataset.index);
              const mission = missions[index];
              if (mission && !mission.completed && mission.currentProgress >= mission.target) {
                  coins += mission.reward;
                  mission.completed = true;
                  saveGameData();
                  updateCurrencyDisplay();
                  updateMissionsDisplay();
                  showMessage(`Mission Complete! +${mission.reward} Coins!`);
                  if (soundOn) missionCompleteSound.play().catch(() => {});
              }
          };
      });
  }

  function completeMission(id, value = 1) {
      missions.forEach(mission => {
          if (!mission.completed) {
              if (mission.id === id) {
                  if (id === 'score' || id === 'coinsEarned') {
                      if (value > mission.currentProgress) { 
                          mission.currentProgress = value;
                      }
                  } else if (id === 'runsPlayed' || id === 'powerupsCollected') {
                      mission.currentProgress += value;
                  }
              }
          }
      });
      saveGameData();
  }

  // Tutorial Function
  function showTutorial() {
      const hasSeenTutorial = localStorage.getItem('hasSeenTutorial') === 'true';
      if (!hasSeenTutorial) {
          tutorialOverlay.style.display = 'flex';
          localStorage.setItem('hasSeenTutorial', 'true');
          saveGameData();
      }
  }

  // Store tab switching logic
  function showStoreTab(tabId) {
      document.querySelectorAll('.store-section').forEach(section => {
          section.classList.remove('active');
      });
      document.querySelectorAll('#store-tabs button').forEach(button => {
          button.classList.remove('active');
      });
      document.getElementById(tabId).classList.add('active');
      document.querySelector(`[data-tab-target="${tabId}"]`).classList.add('active');
  }

  document.getElementById('tab-skins').onclick = () => showStoreTab('skins-section');
  document.getElementById('tab-coin-packs').onclick = () => showStoreTab('coin-packs-section');
  document.getElementById('tab-upgrades').onclick = () => showStoreTab('upgrades-section');
  document.getElementById('tab-pre-game-boosts').onclick = () => showStoreTab('pre-game-boosts-section');


  window.addEventListener('keydown', e => {
    if (!player || !gameActive || paused || adPlaying) return;
    if (e.key === 'ArrowLeft' || e.key === 'a' || e.key === 'A') player.movingLeft = true;
    if (e.key === 'ArrowRight' || e.key === 'd' || e.key === 'D') player.movingRight = true;
  });

  window.addEventListener('keyup', e => {
    if (!player) return;
    if (e.key === 'ArrowLeft' || e.key === 'a' || e.key === 'A') player.movingLeft = false;
    if (e.key === 'ArrowRight' || e.key === 'd' || e.key === 'D') player.movingRight = false;
  });

  canvas.addEventListener('touchstart', e => {
    if (!player || !gameActive || paused || adPlaying) return;
    e.preventDefault();
    const touch = e.touches[0];
    const rect = canvas.getBoundingClientRect();
    const touchX = touch.clientX - rect.left;
    
    if (touchX < width / 2) {
      player.movingLeft = true;
    } else {
      player.movingRight = true;
    }
  }, { passive: false }); 

  canvas.addEventListener('touchend', e => {
    if (!player) return;
    e.preventDefault();
    player.movingLeft = false;
    player.movingRight = false;
  });

  canvas.addEventListener('touchmove', e => {
    e.preventDefault();
  }, { passive: false }); 


  window.addEventListener('resize', () => {
    resize();
    if (player) {
      player.y = height - player.radius - 50;
      player.x = Math.max(player.radius, Math.min(player.x, width - player.radius));
    }
  });

  document.getElementById('play-btn').onclick = startGame;
  document.getElementById('retry-btn').onclick = startGame;

  document.getElementById('store-btn').onclick = () => {
    document.getElementById('start-screen').style.display = 'none';
    storeScreen.style.display = 'flex';
    renderSkinStore();
    renderCoinPacks();
    renderUpgrades();
    renderPreGamePowerups();
    // Set default tab to skins when opening store
    showStoreTab('skins-section');
  };

  document.getElementById('close-store-btn').onclick = () => {
    storeScreen.style.display = 'none';
    document.getElementById('start-screen').style.display = 'flex';
  };

  document.getElementById('how-to-play-btn').onclick = () => {
    document.getElementById('start-screen').style.display = 'none';
    howToPlayScreen.style.display = 'flex';
  };

  document.getElementById('close-how-to-play-btn').onclick = () => {
    howToPlayScreen.style.display = 'none';
    document.getElementById('start-screen').style.display = 'flex';
  };

  document.getElementById('daily-reward-btn').onclick = () => {
      showDailyReward();
  };

  document.getElementById('missions-btn').onclick = () => {
      document.getElementById('start-screen').style.display = 'none';
      missionScreen.style.display = 'flex';
      updateMissionsDisplay();
  };
  document.getElementById('close-missions-btn').onclick = () => {
      missionScreen.style.display = 'none';
      document.getElementById('start-screen').style.display = 'flex';
  };

  document.getElementById('tutorial-close-btn').onclick = () => {
      tutorialOverlay.style.display = 'none';
      document.getElementById('start-screen').style.display = 'flex';
  };

  document.getElementById('no-thanks-btn').onclick = () => {
    document.getElementById('continue-screen').style.display = 'none';
    endGame();
  };

  document.getElementById('watch-ad-btn').onclick = () => {
    if (adPlaying) return;
    adPlaying = true;
    document.getElementById('watch-ad-btn').disabled = true;
    document.getElementById('watch-ad-btn').textContent = 'Loading Ad...';

    let secondsLeft = 5;
    const interval = setInterval(() => {
      document.getElementById('watch-ad-btn').textContent = `Ad ends in ${secondsLeft--}s`;
      if (secondsLeft < 0) {
        clearInterval(interval);
        document.getElementById('continue-screen').style.display = 'none';
        
        createPlayer(); 
        player.invincible = true; 
        player.invincibleTimer = 120 * (1 / GLOBAL_SPEED_MULTIPLIER);
        gameActive = true;
        paused = false;
        adPlaying = false;
        document.getElementById('watch-ad-btn').disabled = false;
        document.getElementById('watch-ad-btn').textContent = 'Watch Ad';
        if (soundOn) bgMusic.play().catch(() => {});
        requestAnimationFrame(update);
      }
    }, 1000 * (1 / GLOBAL_SPEED_MULTIPLIER));
  };

  toggleSoundBtn.onclick = () => {
    soundOn = !soundOn;
    toggleSoundBtn.textContent = soundOn ? '🔊' : '🔇';
    if (soundOn) {
      if (gameActive) bgMusic.play().catch(() => {});
    } else {
      bgMusic.pause();
    }
  };

  togglePauseBtn.onclick = () => {
    if (!gameActive && !paused) return; 
    paused = !paused;
    togglePauseBtn.textContent = paused ? '▶️' : '⏸️';
    if (!paused) {
      if (soundOn) bgMusic.play().catch(() => {});
      requestAnimationFrame(update); 
    } else {
      bgMusic.pause();
    }
  };

  // Initial load and setup
  loadGameData();
  resize();
  createPlayer(); 
  updateHighScoreDisplays();
  updateCurrencyDisplay();
  checkDailyReward();
  resetMissionsDaily();
  showTutorial(); 
  requestAnimationFrame(update);

})();
</script>
</body>
</html>
