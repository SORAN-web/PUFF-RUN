<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Puff Run - Dream Edition Super Advanced</title>
<style>
  /* ... [UNCHANGED STYLES, omitted for brevity] ... */
</style>
<link href="https://fonts.googleapis.com/css2?family=Rubik:wght@700&display=swap" rel="stylesheet" />
</head>
<body>

<canvas id="game-canvas"></canvas>
<div id="score-display">Score: 0</div>
<div id="high-score-display"></div>
<div id="level-message"></div>
<div id="message-box"></div>
<button id="toggle-sound" title="Toggle Sound">üîä</button>
<button id="toggle-pause" title="Pause/Resume">‚è∏Ô∏è</button>

<div id="start-screen">
  <div>Welcome to Puff Run - Dream Edition</div>
  <button id="play-btn">Start Game</button>
  <button id="store-btn">üé® Skins</button>
  <div style="font-size: 1rem; margin-top: 30px; opacity: 0.7;">Use Arrow keys or A/D to move</div>
</div>

<div id="game-over-screen" style="display:none;">
  <div id="score-display-final"></div>
  <button id="retry-btn">Play Again</button>
</div>

<div id="continue-screen" style="display:none;">
  <div>You hit an obstacle! Watch an ad to continue?</div>
  <button id="watch-ad-btn">Watch Ad</button>
  <button id="no-thanks-btn">No Thanks</button>
</div>

<div id="skin-store" style="display:none;">
  <h2>Select Your Dreamy Skin</h2>
  <div id="skin-list"></div>
  <button id="close-skin-store-btn">Close</button>
</div>

<!-- Audio -->
<audio id="bg-music" loop preload="auto" src="long-file.mp3"></audio>
<audio id="hit-sound" preload="auto" src="short-file.mp3"></audio>
<audio id="powerup-sound" preload="auto" src="powerup.mp3"></audio>

<script>
(() => {
  // ... [SAME AS BEFORE for most parts, only showing changes/fixes] ...

  // [1] Fix: Properly update high score after game over and save it
  function endGame() {
    gameActive = false;
    if (score > highScore) {
      highScore = score;
      highScoreDisplay.textContent = `High Score: ${highScore}`;
    }
    document.getElementById('score-display-final').textContent = `Score: ${score}`;
    document.getElementById('game-over-screen').style.display='flex';
    bgMusic.pause();
    saveGameData();
  }

  // [2] Fix: Reset player movement flags on game start/continue
  function createPlayer() {
    player = {
      x: width/2,
      y: height - 75,
      radius: 26,
      velocityX: 0,
      acceleration: 1.1,
      maxSpeed: 10 + currentLevel * 0.3,
      friction: 0.85,
      colors: selectedSkin.colors,
      shield: false,
      shieldAlpha: 0,
      movingLeft: false,
      movingRight: false
    };
  }

  // [3] Fix: Prevent player from moving on screens other than active gameplay
  window.addEventListener('keydown', e => {
    if(!player || !gameActive || paused || adPlaying) return;
    if(e.key==='ArrowLeft' || e.key==='a' || e.key==='A') player.movingLeft=true;
    if(e.key==='ArrowRight' || e.key==='d' || e.key==='D') player.movingRight=true;
  });
  window.addEventListener('keyup', e => {
    if(!player || !gameActive || paused || adPlaying) return;
    if(e.key==='ArrowLeft' || e.key==='a' || e.key==='A') player.movingLeft=false;
    if(e.key==='ArrowRight' || e.key==='d' || e.key==='D') player.movingRight=false;
  });

  // [4] Fix: Always call saveGameData() after purchasing or selecting skin 
  function renderSkinStore() {
    skinList.innerHTML='';
    skins.forEach(skin => {
      const btn = document.createElement('button');
      if(skin.colors.length===3) {
        btn.style.background= `radial-gradient(circle at center, ${skin.colors.join(',')})`;
      } else {
        btn.style.background= `linear-gradient(135deg, ${skin.colors[0]}, ${skin.colors[1]})`;
      }
      btn.innerHTML= `${skin.name}<br><span class="price-tag">${skin.unlocked ? '‚úîÔ∏è Owned' : `$${skin.price}`}</span>`;
      if(!skin.unlocked && skin.price>0) {
        btn.onclick= ()=> {
          if(confirm(`Buy ${skin.name} for $${skin.price}?`)) {
            skin.unlocked=true;
            selectedSkin=skin;
            saveGameData();
            renderSkinStore();
            showMessage(`Purchased ${skin.name}`);
          }
        };
      } else {
        btn.onclick= ()=> {
          selectedSkin=skin;
          saveGameData();
          document.getElementById('skin-store').style.display='none';
          document.getElementById('start-screen').style.display='flex';
        };
      }
      skinList.appendChild(btn);
    });
  }

  // [5] Fix: When continuing after ad, keep score and obstacles rather than a fresh start
  document.getElementById('watch-ad-btn').onclick = () => {
    if(adPlaying) return;
    adPlaying=true;
    document.getElementById('watch-ad-btn').disabled=true;
    document.getElementById('watch-ad-btn').textContent='Loading Ad...';

    let secondsLeft=5;
    const interval = setInterval(() => {
      document.getElementById('watch-ad-btn').textContent= `Ad ends in ${secondsLeft--}s`;
      if(secondsLeft<0) {
        clearInterval(interval);
        document.getElementById('continue-screen').style.display='none';
        createPlayer();
        // Don't reset score, obstacles, or powerups here (continue where left off)
        gameActive=true;
        paused=false;
        adPlaying=false;
        document.getElementById('watch-ad-btn').disabled=false;
        document.getElementById('watch-ad-btn').textContent='Watch Ad';
        if(soundOn) bgMusic.play().catch(() => {});
        requestAnimationFrame(update);
      }
    }, 1000);
  };

  // [6] Fix: Responsive resizing on window resize
  window.addEventListener('resize', () => {
    resize();
    // Don't reset player on resize, just reposition to fit new screen
    if (player) {
      player.y = height - player.radius - 50;
      player.x = Math.max(player.radius, Math.min(player.x, width - player.radius));
    }
  });

  // [7] Fix: Avoid double-drawing player (was called twice in update())
  // Remove the first call to drawPlayer() in update()
  function update() {
    if(!gameActive || paused || adPlaying) return;

    ctx.clearRect(0, 0, width, height);
    drawBackground();

    // ... [rest is unchanged] ...

    // Remove first drawPlayer();
    // drawPlayer();

    // ... [rest unchanged] ...

    drawPlayer();
    drawObstacles();
    drawPowerups();

    // ... [rest unchanged] ...
    requestAnimationFrame(update);
  }

  // [8] Fix: High score display always correct on start screen, game over, and in-game
  function updateHighScoreDisplays() {
    highScoreDisplay.textContent=`High Score: ${highScore}`;
    if(document.getElementById('score-display-final')) {
      document.getElementById('score-display-final').textContent = `Score: ${score}`;
    }
  }

  // Call updateHighScoreDisplays at all relevant places
  // After loading data:
  loadGameData();
  resize();
  createPlayer();
  updateHighScoreDisplays();
  requestAnimationFrame(update);

  // In startGame and endGame, after updating highScore, call updateHighScoreDisplays
  function startGame() {
    score = 0;
    currentLevel = 1;
    obstacles = [];
    powerups = [];
    particles = [];
    createPlayer();
    gameActive = true;
    paused = false;
    continueAvailable = false;
    adPlaying = false;
    powerupActive = null;
    powerupTimer = 0;

    document.getElementById('start-screen').style.display='none';
    document.getElementById('game-over-screen').style.display='none';
    document.getElementById('continue-screen').style.display='none';
    if(soundOn) {
      bgMusic.volume = 0.4;
      bgMusic.play().catch(() => {});
    }
    if (score > highScore) {
      highScore = score;
    }
    updateHighScoreDisplays();
    requestAnimationFrame(update);
  }

  // The rest of your logic is unchanged

})();
</script>
</body>
</html>
